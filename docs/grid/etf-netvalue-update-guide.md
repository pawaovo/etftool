# ETF基金净值更新操作指南

本文档说明如何设置自动更新ETF基金净值数据的操作步骤。

## 重要说明

**必须使用真实API数据！** 模拟数据仅用于开发和测试环境，绝不可在生产环境中使用模拟数据，以确保数据的准确性和真实性。

## 文件说明

1. `scripts/updateNetValues.js` - 核心脚本，负责从API获取ETF基金最新净值数据并更新到`public/data/grid/latest_netvalues.json`文件
2. `scripts/updateNetValuesFromJson.js` - 辅助脚本，从本地JSON文件导入ETF基金净值数据
3. `update-etf-netvalues.bat` - Windows批处理文件，用于任务计划程序中执行API更新脚本
4. `import-etf-netvalues.bat` - Windows批处理文件，用于从本地JSON文件导入数据

## 数据更新方式

本项目提供两种更新净值数据的方式：

### 方式一：从API获取数据（推荐）

这是推荐的方式，确保获取到最新、真实的数据：

```
# 使用实际API数据（推荐，确保数据准确性）
npm run update-netvalues
```

或者直接双击运行`update-etf-netvalues.bat`文件。

### 方式二：从本地JSON文件导入数据

如果API无法访问或有网络限制，可以通过以下步骤从本地JSON文件导入数据：

1. 准备一个包含最新净值数据的JSON文件（如`netvalues-sample.json`）
2. 运行导入命令：

```
# 从指定的JSON文件导入数据
npm run import-netvalues
```

或者直接双击运行`import-etf-netvalues.bat`文件。

**JSON文件格式示例：**

```json
{
  "159920": { "netValue": 1.0532 },
  "159938": { "netValue": 2.1556 },
  "512880": { "netValue": 1.0325 },
  "512980": { "netValue": 0.8765 },
  "513050": { "netValue": 1.2345 }
}
```

**注意：** 下面的命令仅用于开发测试环境，不应在生产环境中使用：

```
# 使用模拟数据（仅限开发测试）
npm run update-netvalues-mock
```

## 设置Windows任务计划

按照以下步骤在Windows系统中设置每天15:05自动执行更新操作：

1. 打开Windows任务计划程序（可在开始菜单搜索"任务计划程序"）
2. 在右侧面板点击"创建基本任务"
3. 输入任务名称，如"ETF基金净值更新"，点击"下一步"
4. 选择"每天"，点击"下一步"
5. 设置开始时间为15:05，点击"下一步"
   > **注意：** 15:05是交易结束后的时间，确保能获取到当天的最新净值数据
6. 选择"启动程序"，点击"下一步"
7. 在"程序或脚本"字段中浏览并选择项目根目录中的`update-etf-netvalues.bat`文件
8. 在"起始于"字段中输入项目根目录的完整路径（如`D:\ai\etftool`）
9. 点击"下一步"，然后点击"完成"

## 高级设置（可选）

任务创建完成后，可以进行以下高级设置：

1. 右键点击创建的任务，选择"属性"
2. 在"常规"选项卡中，选择"不管用户是否登录都要运行"（需要管理员权限）
3. 在"条件"选项卡中，确保选择"只有在以下网络连接可用时才启动"，因为API调用依赖网络连接
4. 在"设置"选项卡中，建议选择"如果过了计划开始时间，立即启动任务"
5. 点击"确定"保存设置

## 数据质量保障

脚本已实现以下保障数据质量的机制：

1. **多次重试** - 在网络不稳定情况下自动尝试多次API调用
2. **错误处理** - 详细的错误日志记录和处理机制
3. **数据备份** - 每次更新前自动备份原有数据
4. **防止数据丢失** - 如果所有基金数据获取失败，不会覆盖现有文件

## 注意事项

1. 确保计算机在计划执行时间处于开机状态
2. 确保网络连接畅通，能够正常访问API
3. 如果API持续无法访问，可以考虑使用本地JSON文件导入方式
4. 在服务器环境中，可以使用`crontab`（Linux）或其他调度工具代替Windows任务计划程序

## 故障排除

如果任务未能正常执行，请检查：

1. Node.js环境是否正确安装
2. 项目依赖是否完整（执行`npm install`确保安装所有依赖）
3. 批处理文件中的路径是否正确
4. 网络连接是否正常（可以手动在浏览器中访问API验证）
5. Windows事件查看器中是否有相关错误日志 